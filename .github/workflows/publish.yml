---
name: Publish Ansible Collection

on:
  push:
    tags: ["v*.*.*"]
  workflow_dispatch:

jobs:
  validate:
    name: Lint & Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core ansible-lint yamllint

      - name: Yaml Lint (including galaxy.yml)
        run: |
          yamllint -c .yamllint.yml -f standard .
          yamllint -c .yamllint.yml -f standard galaxy.yml

      - name: Ansible Lint
        run: |
          ansible-lint || (echo "ansible-lint failed" && exit 1)

      - name: Validate GitHub Actions workflow syntax
        uses: reviewdog/action-actionlint@v1
        with:
          fail_level: error

      - name: Validate version parity (tag vs galaxy.yml)
        id: version_check
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION_FROM_TAG="${TAG#v}"
          echo "TAG=${TAG}"
          echo "VERSION_FROM_TAG=${VERSION_FROM_TAG}"
          if [ ! -f galaxy.yml ]; then
            echo "galaxy.yml not found at repo root."
            exit 1
          fi
          PYCMD="import yaml,sys; print(yaml.safe_load(open('galaxy.yml')).get('version',''))"
          VERSION_IN_FILE="$(python -c "$PYCMD")"
          echo "VERSION_IN_FILE=${VERSION_IN_FILE}"
          if [ -z "${VERSION_IN_FILE}" ]; then
            echo "No 'version' found in galaxy.yml."
            exit 1
          fi
          if [ "${VERSION_IN_FILE}" != "${VERSION_FROM_TAG}" ]; then
            echo "Version mismatch: tag=${VERSION_FROM_TAG} vs galaxy.yml=${VERSION_IN_FILE}"
            exit 1
          fi
          echo "Version parity OK."

      - name: "Guard: block pre-release tags (-rc/-beta)"
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${GITHUB_REF##*/}"
          if echo "$TAG" | grep -E '(-rc|-beta)' >/dev/null; then
            echo "Pre-release tag ($TAG) detected. Exiting validation."
            exit 1
          fi

      - name: Dry build check (structure validation)
        run: |
          ansible-galaxy collection build --output-path dist/
          test -f dist/*.tar.gz || (echo "Build artifact missing" && exit 1)

  build-and-publish:
    name: Build & Publish
    runs-on: ubuntu-latest
    needs: validate
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core

      - name: Build collection
        run: ansible-galaxy collection build --output-path dist/

      - name: Publish to Ansible Galaxy
        env:
          ANSIBLE_GALAXY_API_KEY: ${{ secrets.ANSIBLE_GALAXY_API_KEY }}
        run: |
          FILE=$(ls dist/*.tar.gz)
          ansible-galaxy collection publish "$FILE" \
            --api-key "$ANSIBLE_GALAXY_API_KEY"
