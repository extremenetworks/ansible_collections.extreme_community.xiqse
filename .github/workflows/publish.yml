name: Publish Ansible Collection

on:
  push:
    tags: ["v[0-9]+.[0-9]+.[0-9]+"]

jobs:
  validate:
    name: Lint & Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core ansible-lint yamllint

      - name: Yaml Lint (including galaxy.yml)
        run: |
          yamllint -f standard .
          yamllint -f standard galaxy.yml

      - name: Ansible Lint
        run: |
          ansible-lint || (echo "ansible-lint failed" && exit 1)

      - name: Validate version parity (tag vs galaxy.yml)
        id: version_check
        run: |
          TAG="${GITHUB_REF##*/}"
          VERSION_FROM_TAG="${TAG#v}"
          echo "TAG=${TAG}"
          echo "VERSION_FROM_TAG=${VERSION_FROM_TAG}"
          if [ ! -f galaxy.yml ]; then
            echo "galaxy.yml not found at repo root."
            exit 1
          fi
          VERSION_IN_FILE="$(python - <<'PY'
import yaml
with open('galaxy.yml') as f:
    data = yaml.safe_load(f)
print(data.get('version',''))
PY
)"
          echo "VERSION_IN_FILE=${VERSION_IN_FILE}"
          if [ -z "${VERSION_IN_FILE}" ]; then
            echo "No 'version' found in galaxy.yml."
            exit 1
          fi
          if [ "${VERSION_IN_FILE}" != "${VERSION_FROM_TAG}" ]; then
            echo "Version mismatch: tag=${VERSION_FROM_TAG} vs galaxy.yml=${VERSION_IN_FILE}"
            exit 1
          fi
          echo "Version parity OK."

      - name: Guard: block pre-release tags (-rc/-beta)
        run: |
          TAG="${GITHUB_REF##*/}"
          if [[ "$TAG" =~ -rc|-beta ]]; then
            echo "Pre-release tag ($TAG) detected. Exiting validation."
            exit 1
          fi

      - name: Dry build check (structure validation)
        run: |
          ansible-galaxy collection build --output-path dist/
          test -f dist/*.tar.gz || (echo "Build artifact missing" && exit 1)

  build-and-publish:
    name: Build & Publish
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core

      - name: Build collection
        run: ansible-galaxy collection build --output-path dist/

      - name: Publish to Ansible Galaxy
        env:
          ANSIBLE_GALAXY_API_KEY: ${{ secrets.ANSIBLE_GALAXY_API_KEY }}
        run: |
          FILE=$(ls dist/*.tar.gz)
          ansible-galaxy collection publish "$FILE" --api-key "$ANSIBLE_GALAXY_API_KEY"
